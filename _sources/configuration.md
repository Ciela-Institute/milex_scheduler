# Configuration

This document provides detailed instructions for the `milex-configuration` command.
The role of this command is to store user-specific details required to connect to
remote SLURM machines and activate virtual environments.
This document includes the steps to create an SSH key and securely access remote
machines. See [Creating an SSH Key](ssh).

The configuration file `~/.milexconfig` stores the following information:

- SLURM account (e.g. `def-bengioy`)
- Virtual environment activation commands (e.g.
  `source /path/to/remote/venv/bin/activate`)
- SSH credentials for remote machines

To get started with the configuration, run this command in a command-line interface:
```bash
milex-configuration
```

## `milex-configuration`

When executed for the first time, `milex-configuration`
will create the configuration file '~/.milexconfig' if it does not exist.
The `~` is used as a shortcut for the home directory.
You should also be presented with the following file template
```json
{
  "local": {
    "path": "/path/to/local/milex",
    "env_command": "source /path/to/local/venv/bin/activate",
    "slurm_account": "def-bengioy"
  },
  "remote_machine": {
    "path": "/path/to/remote/milex",
    "env_command": "source /path/to/remote/venv/bin/activate",
    "slurm_account": "rrg-account_name",
    "hostname": "machine",
    "hosturl": "machine.domain.com",
    "username": "user1",
    "key_path": "~/.ssh/id_rsa"
  }
}
```
In the following sections, each field of this file is explained in
case you need to modify it. If you only need a local machine and
do not plan to use a remote machine, you will only need to configure
entries under the `local` field or similar to it.
```json
{
  "local": {
    "path": "/path/to/local/milex",
    "env_command": "source /path/to/local/venv/bin/activate",
    "slurm_account": "def-bengioy"
  }
}
```

### Local machine

`local` is the name of the machine where you are currently running the
`milex-configuration` command. It must always be present in the configuration
file.

#### `path`

This field specifies the absolute path to a directory where scripts, jobs, and
various other things will be stored for reproducibility. Once the configuration
is complete, the following directory structure will be created automatically

```
$MILEX
├── jobs
│   ├── *bundle_name*_*date*.json
├── slurm
│   ├── *script_name*_*date*.sh
├── models
├── results
└── data
```
`$MILEX` is an environment variable automatically appended to your `.bashrc` file
by `milex-configuration` using the path specified in the `path` field.

As jobs are scheduled , the `jobs` directory will be populated with
JSON files that store job configurations.
The `slurm` directory is populated once jobs are submitted with the corresponding
SLURM shell automatically generated by `milex` and output files created by SLURM.

**Notes**:

- `*date*` is a timestamp automatically generated when a job is scheduled.
  The format is `YYYYmmDDHHMMSS`.
- In case multiple jobs are created simultaneously with the same name,
    `milex` will append a unique timestamp to each by adding seconds to the
    timestamp.

#### `env_command`

This field is used to activate a Python virtual environment before running jobs.
If you are using `virtualenv`, the command will look like this:

```bash
source /path/to/venv/bin/activate
```

If you use `conda`, the command will look like this:

```bash
conda activate myenv
```

The virtual environment is always activated before running the job.
SLURM script generated by `milex` have this generic structure:

```bash
#!/bin/bash
# SBATCH ...

# Activate the virtual environment
source /path/to/venv/bin/activate # Content of the `env_command` field

# Run the job
python my_script
```

#### `slurm_account`

This field specifies the SLURM account for job submission.
Each machine should have a unique SLURM account.
If you have multiple SLURM accounts on the same machine,
then you can create multiple configurations in the `~/.milexconfig` file
to use the various accounts.

```json
{
  "local": {
    "path": "/path/to/local/milex",
    "env_command": "source /path/to/local/venv/bin/activate",
    "slurm_account": "def-bengioy"
  },
  "local_rrg": {
    "path": "/path/to/local/milex",
    "env_command": "source /path/to/local/venv/bin/activate",
    "slurm_account": "rrg-bengioy"
  }
}
```

### Remote machine

The `remote_machine` field is optional.
It is used to specify the configuration details for a remote machine,
i.e. a machine accessible via SSH protocols.

**Notes**:
- The `path` field must be an absolute path with respect to the remote machine.

#### `hostname`

This field specifies the hostname of a remote machine from the `~/.ssh/config`
file. For more details on how to create an SSH config file, see the section
[Create an SSH config file](config).

**Note**: This is the preferable way to specify the hostname of the remote
machine. If provided, the other fields `hosturl`, `username`, and `key_path` are
not required.

#### `username`

This field specifies a username to access an account on the remote machine.

#### `hosturl`

This field specifies the URL of the remote machine. For example,
`beluga.computecanada.ca`.

#### `key_path`

This field specifies the path to the SSH private key used to connect to the machine.
For example, `~/.ssh/id_rsa`. See the section [Creating an SSH Key](ssh) for instructions on
how to create an SSH key.

(ssh)=
## Create an SSH Key

### Generate an SSH Key

An SSH key is generated using the `ssh-keygen` command. For example

```bash
ssh-keygen -t rsa -b 4096 "my_email@example.com"
```

You can find more information about the `ssh-keygen` command by running
`man ssh-keygen` or visiting [this GitHub instruction page](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent)
for a walkthrough of the process.
The key will be saved in the `~/.ssh` directory by default.
The public key can be distinguished by the `.pub` extension from
the private key.

### Link an SSH Key to the remote machine

Use the `ssh-copy-id` command to register the public key in the `authorized_keys`
file on the remote machines.

```bash
ssh-copy-id -i ~/.ssh/id_rsa.pub username@hostname
```
With this setup, you will not be prompted for a password when connecting to the
remote machine.

```bash
ssh username@hostname
```

(config)=
## Create an SSH config file (recommended)

To simplify the SSH connection process even more, a config
file can be created as follows `touch ~/.ssh/config`.

```bash
Host remote_machine
    HostName hostname
    User username
    IdentityFile ~/.ssh/id_rsa
```

The name of the host `remote_machine`, is now associated with the full
SSH configuration, such that you can connect to the remote machine by running

```bash
ssh remote_machine
```

You can use this name also in the `~/.milexconfig` file to specify the hostname
field.

### 2FA authentication

In case a 2FA protocol is enabled on the remote machine, persistence can be added
to the ssh-agent to avoid prompting the 2FA authentication process

```bash
Host remote_machine
    HostName hostname
    User username
    IdentityFile ~/.ssh/id_rsa
    ServerAliveInterval 60
    ControlMaster auto
    ControlPersist yes
    ControlPath ~/.ssh/sockets/%r@%h-%p
```

`ServerAliveInterval 60` will send a keep-alive signal to the server every 60
seconds to keep the connection alive.
The `ControlMaster` and `ControlPersist` options are used to
multiplex SSH connections, meaning that you can open multiple SSH sessions to
the same server without having to re-authenticate each time.

This configuration is **highly recommended** for remote machines that require
2FA authentication. It is especially useful when you have multiple jobs to run on
a remote machine.
